{ parameter
    (or (or (unit %buyTicket) (nat %closeRaffle))
        (pair %openRaffle (pair (pair mutez timestamp) (pair (option string) bytes)) mutez)) ;
  storage
    (pair (pair (pair (pair (address %admin) (timestamp %close_date))
                      (pair (string %description) (mutez %jackpot)))
                (pair (pair (set %players address) (bool %raffle_is_open))
                      (pair (big_map %sold_tickets nat address) (mutez %ticket_price))))
          (bytes %winning_ticket_number_hash)) ;
  code { UNPAIR ;
         IF_LEFT
           { IF_LEFT
               { DROP ;
                 DUP ;
                 CAR ;
                 CDR ;
                 CAR ;
                 CDR ;
                 IF { SENDER ;
                      SWAP ;
                      DUP ;
                      DUG 2 ;
                      CAR ;
                      CDR ;
                      CDR ;
                      CDR ;
                      AMOUNT ;
                      COMPARE ;
                      LE ;
                      IF { DROP 2 ;
                           PUSH string "The sender does not own enough tz to buy a ticket." ;
                           FAILWITH }
                         { SWAP ;
                           DUP ;
                           DUG 2 ;
                           CAR ;
                           CDR ;
                           CAR ;
                           CAR ;
                           SWAP ;
                           DUP ;
                           DUG 2 ;
                           MEM ;
                           IF { DROP 2 ; PUSH string "Each player can participate only once." ; FAILWITH }
                              { SWAP ;
                                DUP ;
                                DUG 2 ;
                                CDR ;
                                DUP 3 ;
                                CAR ;
                                CDR ;
                                CDR ;
                                DUP 4 ;
                                CAR ;
                                CDR ;
                                CAR ;
                                CDR ;
                                DUP 5 ;
                                CAR ;
                                CDR ;
                                CAR ;
                                CAR ;
                                DUP 5 ;
                                PUSH bool True ;
                                SWAP ;
                                UPDATE ;
                                PAIR ;
                                PAIR ;
                                DUP 4 ;
                                CAR ;
                                CAR ;
                                PAIR ;
                                PAIR ;
                                DUP ;
                                CDR ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                CAR ;
                                CDR ;
                                CDR ;
                                CDR ;
                                DUP 5 ;
                                CAR ;
                                CDR ;
                                CDR ;
                                CAR ;
                                DIG 4 ;
                                SOME ;
                                DIG 5 ;
                                CAR ;
                                CDR ;
                                CAR ;
                                CAR ;
                                SIZE ;
                                UPDATE ;
                                PAIR ;
                                DUP 3 ;
                                CAR ;
                                CDR ;
                                CAR ;
                                PAIR ;
                                DIG 2 ;
                                CAR ;
                                CAR ;
                                PAIR ;
                                PAIR ;
                                NIL operation ;
                                PAIR } } }
                    { DROP ; PUSH string "The raffle is closed." ; FAILWITH } }
               { SWAP ;
                 DUP ;
                 DUG 2 ;
                 CAR ;
                 CAR ;
                 CAR ;
                 CAR ;
                 SOURCE ;
                 COMPARE ;
                 NEQ ;
                 IF { DROP 2 ; PUSH string "Administrator not recognized" ; FAILWITH }
                    { SWAP ;
                      DUP ;
                      DUG 2 ;
                      CAR ;
                      CDR ;
                      CAR ;
                      CDR ;
                      IF { SWAP ;
                           DUP ;
                           DUG 2 ;
                           CAR ;
                           CAR ;
                           CAR ;
                           CDR ;
                           NOW ;
                           COMPARE ;
                           LT ;
                           IF { DROP 2 ;
                                PUSH string "The raffle must remain open for at least 7 days" ;
                                FAILWITH }
                              { SWAP ;
                                DUP ;
                                DUG 2 ;
                                CDR ;
                                SWAP ;
                                DUP ;
                                DUG 2 ;
                                PACK ;
                                SHA256 ;
                                COMPARE ;
                                NEQ ;
                                IF { DROP 2 ;
                                     PUSH string "The hash does not match the hash of the winning ticket." ;
                                     FAILWITH }
                                   { SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     CAR ;
                                     CAR ;
                                     SIZE ;
                                     SWAP ;
                                     EDIV ;
                                     IF_NONE { PUSH string "MOD by 0" ; FAILWITH } {} ;
                                     CDR ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     CDR ;
                                     CAR ;
                                     SWAP ;
                                     GET ;
                                     IF_NONE { PUSH string "Winner address not found" ; FAILWITH } {} ;
                                     CONTRACT unit ;
                                     IF_NONE { PUSH string "Winner contract not found" ; FAILWITH } {} ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CAR ;
                                     CDR ;
                                     CDR ;
                                     UNIT ;
                                     TRANSFER_TOKENS ;
                                     DROP ;
                                     DUP ;
                                     CDR ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     PUSH mutez 0 ;
                                     DUP 4 ;
                                     CAR ;
                                     CAR ;
                                     CDR ;
                                     CAR ;
                                     PAIR ;
                                     DIG 3 ;
                                     CAR ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     PAIR ;
                                     DUP ;
                                     CDR ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     DUP 3 ;
                                     CAR ;
                                     CAR ;
                                     CDR ;
                                     PUSH timestamp 0 ;
                                     DIG 4 ;
                                     CAR ;
                                     CAR ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     PAIR ;
                                     PAIR ;
                                     DUP ;
                                     CDR ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     DUP 3 ;
                                     CAR ;
                                     CAR ;
                                     CDR ;
                                     CDR ;
                                     PUSH string "raffle is currently closed" ;
                                     PAIR ;
                                     DIG 3 ;
                                     CAR ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     PAIR ;
                                     DUP ;
                                     CDR ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     CDR ;
                                     PUSH bool False ;
                                     DUP 4 ;
                                     CAR ;
                                     CDR ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     DIG 2 ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     DUP ;
                                     CDR ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     CDR ;
                                     DUP 3 ;
                                     CAR ;
                                     CDR ;
                                     CAR ;
                                     CDR ;
                                     EMPTY_SET address ;
                                     PAIR ;
                                     PAIR ;
                                     DIG 2 ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     DUP ;
                                     CDR ;
                                     SWAP ;
                                     DUP ;
                                     DUG 2 ;
                                     CAR ;
                                     CDR ;
                                     CDR ;
                                     CDR ;
                                     EMPTY_BIG_MAP nat address ;
                                     PAIR ;
                                     DUP 3 ;
                                     CAR ;
                                     CDR ;
                                     CAR ;
                                     PAIR ;
                                     DIG 2 ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     DUP ;
                                     CDR ;
                                     PUSH mutez 0 ;
                                     DUP 3 ;
                                     CAR ;
                                     CDR ;
                                     CDR ;
                                     CAR ;
                                     PAIR ;
                                     DUP 3 ;
                                     CAR ;
                                     CDR ;
                                     CAR ;
                                     PAIR ;
                                     DIG 2 ;
                                     CAR ;
                                     CAR ;
                                     PAIR ;
                                     PAIR ;
                                     NIL operation ;
                                     PAIR } } }
                         { DROP 2 ; PUSH string "The raffle is closed." ; FAILWITH } } } }
           { SWAP ;
             DUP ;
             DUG 2 ;
             CAR ;
             CAR ;
             CAR ;
             CAR ;
             SOURCE ;
             COMPARE ;
             NEQ ;
             IF { DROP 2 ; PUSH string "Administrator not recognized." ; FAILWITH }
                { SWAP ;
                  DUP ;
                  DUG 2 ;
                  CAR ;
                  CDR ;
                  CAR ;
                  CDR ;
                  NOT ;
                  IF { UNPAIR ;
                       UNPAIR ;
                       UNPAIR ;
                       DIG 2 ;
                       UNPAIR ;
                       DUP 3 ;
                       AMOUNT ;
                       COMPARE ;
                       LT ;
                       IF { DROP 6 ;
                            PUSH string "The administrator does not own enought tz." ;
                            FAILWITH }
                          { NOW ;
                            PUSH int 86400 ;
                            PUSH int 7 ;
                            MUL ;
                            ADD ;
                            DUP 5 ;
                            COMPARE ;
                            LT ;
                            IF { DROP 6 ;
                                 PUSH string "The raffle must remain open for at least 7 days." ;
                                 FAILWITH }
                               { SWAP ;
                                 DUP 6 ;
                                 CDR ;
                                 DUP 7 ;
                                 CAR ;
                                 CDR ;
                                 DIG 4 ;
                                 DUP 8 ;
                                 CAR ;
                                 CAR ;
                                 CDR ;
                                 CAR ;
                                 PAIR ;
                                 DUP 8 ;
                                 CAR ;
                                 CAR ;
                                 CAR ;
                                 PAIR ;
                                 PAIR ;
                                 PAIR ;
                                 DUP ;
                                 CDR ;
                                 SWAP ;
                                 DUP ;
                                 DUG 2 ;
                                 CAR ;
                                 CDR ;
                                 DUP 3 ;
                                 CAR ;
                                 CAR ;
                                 CDR ;
                                 DIG 6 ;
                                 DIG 4 ;
                                 CAR ;
                                 CAR ;
                                 CAR ;
                                 CAR ;
                                 PAIR ;
                                 PAIR ;
                                 PAIR ;
                                 PAIR ;
                                 DUP ;
                                 CDR ;
                                 SWAP ;
                                 DUP ;
                                 DUG 2 ;
                                 CAR ;
                                 CDR ;
                                 CDR ;
                                 PUSH bool True ;
                                 DUP 4 ;
                                 CAR ;
                                 CDR ;
                                 CAR ;
                                 CAR ;
                                 PAIR ;
                                 PAIR ;
                                 DIG 2 ;
                                 CAR ;
                                 CAR ;
                                 PAIR ;
                                 PAIR ;
                                 CAR ;
                                 PAIR ;
                                 DUP ;
                                 CDR ;
                                 SWAP ;
                                 DUP ;
                                 DUG 2 ;
                                 CAR ;
                                 CDR ;
                                 DUP 3 ;
                                 CAR ;
                                 CAR ;
                                 CDR ;
                                 CDR ;
                                 DIG 4 ;
                                 IF_NONE { DIG 5 ; CAR ; CAR ; CDR ; CAR } { DIG 6 ; DROP } ;
                                 PAIR ;
                                 DIG 3 ;
                                 CAR ;
                                 CAR ;
                                 CAR ;
                                 PAIR ;
                                 PAIR ;
                                 PAIR ;
                                 DUP ;
                                 CDR ;
                                 DUG 2 ;
                                 DUP ;
                                 DUG 3 ;
                                 CAR ;
                                 CDR ;
                                 CDR ;
                                 CAR ;
                                 PAIR ;
                                 DUP 3 ;
                                 CAR ;
                                 CDR ;
                                 CAR ;
                                 PAIR ;
                                 DIG 2 ;
                                 CAR ;
                                 CAR ;
                                 PAIR ;
                                 PAIR ;
                                 NIL operation ;
                                 PAIR } } }
                     { DROP 2 ; PUSH string "A raffle is already open" ; FAILWITH } } } } }
